/*
 * @author      OA Wu <comdan66@gmail.com>
 * @copyright   Copyright (c) 2015 - 2019, Ginkgo
 * @license     http://opensource.org/licenses/MIT  MIT License
 * @link        https://www.ioa.tw/
 */

$(function(){function a(t){return $("<"+t+" />")}function r(){return a("div")}function h(){return a("header")}function u(){return a("i")}function c(){return a("label")}function d(t){if(!(this instanceof d))return new d(t);function s(){this.E.remove(),this.viewControllers=[]}this.present=function(t,i,n){if(!(t instanceof f))throw new Error("viewController 格式錯誤！");null===this.E&&(this.E=r().attr("id",this.option.id).attr("class",this.option.class).appendTo(d.body()));var e=t.viewWillLoad().viewDidLoad();return this.viewControllers.push(e),this.E.append(e),n=void 0===n||n,i="function"==typeof i?i.bind(t):null,n?setTimeout(function(){e.addClass(t.presentClass()),setTimeout(function(){i&&i(),t.viewEndLoad()}.bind(this),300)}.bind(this),100):(e.addClass(t.presentClass()),i&&i(),t.viewEndLoad()),this},this.dismiss=function(t,i,n){if(!(t instanceof f))throw new Error("viewController 格式錯誤！");var e=this.viewControllers.pop();if(e!==t.viewDidLoad())return!1;n=void 0===n||n,i="function"==typeof i?i.bind(t):null,e.removeClass(t.presentClass()),n?setTimeout(function(){e.remove(),this.viewControllers.length||s.bind(this)(),i&&i()}.bind(this),300):(e.remove(),this.viewControllers.length||s.bind(this)(),i&&i())},this.E=null,this.viewControllers=[],this.option=$.extend({id:null,class:null},t)}function p(t){if(!(this instanceof p))return new p(t);var n=null,e=null;if(this._actions=[],this.append=function(t){return null===n?this._actions.push({action:"append",param:t}):n.append(t),this},this.attr=function(t,i){return null===n?this._actions.push({action:"attr",param:{key:t,val:i}}):n.attr(t,i),this},this.addClass=function(t){return null===n?this._actions.push({action:"addClass",param:t}):n.addClass(t),this},this.text=function(t){return null===n?this._actions.push({action:"text",param:t}):n.text(t),this},this.click=function(t){return null===n?this._actions.push({action:"click",param:t}):n.unbind("click").click(t.bind(e)),this},this.removeClass=function(t){return null===n?this._actions.push({action:"removeClass",param:t}):n.removeClass(t),this},this.setUpEl=function(){var t=this.$el.clone(!0);return this._actions.forEach(function(t){switch(t.action){case"append":this.append(t.param);break;case"attr":this.attr(t.param.key,t.param.val);break;case"addClass":this.addClass(t.param);break;case"text":this.text(t.param);break;case"click":this.unbind("click").click(t.param&&t.param.bind(e));break;case"removeClass":this.removeClass(t.param)}}.bind(t)),t},this.viewWillLoad=function(){return this},this.viewDidLoad=function(){return null!==n?n:n=this.setUpEl()},this.viewEndLoad=function(){return this},this.controller=function(t,i){return void 0===t?e:(t instanceof f&&(e=t),this)},!((t=$.extend({id:null,class:"View",$el:r()},t)).$el instanceof jQuery))throw new Error("View $el(元素) 格式錯誤，必須要為 jQuery 元素！");this.$el=t.$el,this.attr("id",t.id).attr("class",t.class),t=null,delete t}function f(t){if(!(this instanceof f))return new f(t);var i="present",n=null,e=null,s=null,l=null,o=null;this._actions=[],this.append=function(t){return null===n?this._actions.push({action:"append",param:t}):n.append(t),this},this.attr=function(t,i){return null===n?this._actions.push({action:"attr",param:{key:t,val:i}}):n.attr(t,i),this},this.addClass=function(t){return null===n?this._actions.push({action:"addClass",param:t}):n.addClass(t),this},this.removeClass=function(t){return null===n?this._actions.push({action:"removeClass",param:t}):n.removeClass(t),this},this.presentClass=function(t){return void 0===t?i:i=t},this.setUpEl=function(){var t=this.$el.clone();return this._actions.forEach(function(t){switch(t.action){case"append":this.append(t.param);break;case"attr":this.attr(t.param.key,t.param.val);break;case"addClass":this.addClass(t.param);break;case"removeClass":this.removeClass(t.param)}}.bind(t)),t},this.present=function(t,i){d.main().present(this.navigationController()||this,t,i)},this.dismiss=function(t,i){d.main().dismiss(this.navigationController()||this,t,i)},this.viewWillLoad=function(){return this},this.viewDidLoad=function(){return null!==n?n:n=this.setUpEl().append(this.view.controller(this).viewWillLoad().viewDidLoad())},this.viewEndLoad=function(){return this},this.navigationController=function(t){return void 0===t?e:(t instanceof C&&(e=t),this)},this.left=function(t,i){return void 0===t?s:(this.navigationController()&&this.navigationController().navigationBar()?this.navigationController().navigationBar().left(t,i):(null===s&&(s=v(null,null,{$el:c()})),"string"==typeof t&&s.text(t),"function"==typeof i&&s.click(i)),this)},this.title=function(t,i){return void 0===t?l:(this.navigationController()&&this.navigationController().navigationBar()?this.navigationController().navigationBar().title(t,i):(null===l&&(l=v(null,null,{$el:h()})),"string"==typeof t&&l.text(t),"function"==typeof i&&l.click(i)),this)},this.right=function(t,i){return void 0===t?o:(this.navigationController()&&this.navigationController().navigationBar()?this.navigationController().navigationBar().right(t,i):(null===o&&(o=v(null,null,{$el:c()})),"string"==typeof t&&o.text(t),"function"==typeof i&&o.click(i)),this)},this.pop=function(t,i){return this.navigationController()?this.navigationController().pop(t,i):this},this.push=function(t,i,n){return this.navigationController()?this.navigationController().push(t,i,n):this},this.view=p(),t=$.extend({id:null,class:"Controller",presentClass:"present",$el:r()},t),this.$el=t.$el,this.attr("id",t.id).attr("class",t.class).presentClass(t.presentClass),t=null,delete t}function v(t,i,n){if(!(this instanceof v))return new v(t,i,n);p.call(this,$.extend({class:null},n)),n=null,delete n}function w(t,i,n,e){if(!(this instanceof w))return new w(t,i,n,e);p.call(this,$.extend({class:"NavigationBar"},e));var s=null,l=null,o=n,r=t,a=i;this.navigationController=function(t){return void 0===t?l:(t instanceof C&&(l=t),this)},this.left=function(t,i,n){return void 0===t?o:(null===o&&(o=v(null,null,{$el:c()})),"string"==typeof t&&o.text(t),"function"==typeof i&&o.click(i),o.addClass(n),this)},this.title=function(t,i,n){return void 0===t?r:(null===r&&(r=v(null,null,{$el:h()})),"string"==typeof t&&r.text(t),"function"==typeof i&&r.click(i),r.addClass(n),this)},this.right=function(t,i,n){return void 0===t?a:(null===a&&(a=v(null,null,{$el:c()})),"string"==typeof t&&a.text(t),"function"==typeof i&&a.click(i),a.addClass(n),this)},this.viewDidLoad=function(){return null!==s?s:s=this.setUpEl().append(o&&o.controller(this.navigationController()).viewWillLoad().viewDidLoad()).append((r||this.title("")).controller(this.navigationController()).viewWillLoad().viewDidLoad()).append(a&&a.controller(this.navigationController()).viewWillLoad().viewDidLoad())},e=null,delete e}function C(s,t){if(!(this instanceof C))return new C(s,t);if(f.call(this,t),void 0===s)throw new Error("NavigationController 沒有 Root ViewController！");var i="push",l=null,o=[];function r(t){return t.removeClass("Controller").addClass("NavigationController").viewWillLoad(),"string"==typeof t.title&&this.navigationBar().title(t.title),t.append(1<this.viewControllers().length&&null===this.navigationBar().left()?this.navigationBar().left("返回",this.pop,"back").viewDidLoad():this.navigationBar().viewDidLoad())}this.viewDidLoad=function(){return null!==l?l:l=this.setUpEl().append(r.call(this,s.navigationController(this)).addClass(this.pushClass()).viewDidLoad())},this.viewEndLoad=function(){return this.viewController().viewEndLoad(),this},this.push=function(t,i,n){if(!(t instanceof f))throw new Error("viewController 格式錯誤！");t.navigationController(this);var e=w(t.title(),t.right(),t.left()).navigationController(this);return o.push({navigationBar:e,viewController:t}),null===l||(l.append(r.call(this,t).viewDidLoad()),n=void 0===n||n,i="function"==typeof i?i.bind(this):null,n?setTimeout(function(){t.viewDidLoad().addClass(this.pushClass()),setTimeout(function(){i&&i(),t.viewEndLoad()}.bind(this),300)}.bind(this),100):(t.viewDidLoad().addClass(this.pushClass()),i&&i(),t.viewEndLoad())),this},this.pop=function(t,i){i=void 0===i||i,t="function"==typeof t?t.bind(this):null;var n=o.pop();if(n.viewController==s)return this.dismiss(t,i);var e=n.viewController.viewDidLoad();e.removeClass(this.pushClass()),i?setTimeout(function(){e.remove(),n=null,delete n,e=null,delete e,t&&t()}.bind(this),300):(e.remove(),n=null,delete n,e=null,delete e,t&&t())},this.pushClass=function(t){return void 0===t?i:(i=t,this)},this.viewControllers=function(){return o},this.viewController=function(){if(o.length)return o[o.length-1].viewController;throw new Error("NavigationController 錯誤！")},this.navigationBar=function(){if(o.length)return o[o.length-1].navigationBar;throw new Error("NavigationController 錯誤！")},this.push(s,null,!1).pushClass($.extend({pushClass:"push"},t).pushClass),t=null,delete t}function b(t,i,n,e,s,l){if(!(this instanceof b))return new b(t,i,n,e,s,l);p.call(this,$.extend({$el:c(),class:"TableViewCell"+(t?" TableViewCellIcon "+t:"")},l));var o=null,r="TableViewCellArrow",a="TableViewCellSwitch",h="TableViewCellSwitchOn";this.viewDidLoad=function(){return null!==o?o:(o=this.setUpEl(),"boolean"==typeof s?o.attr("data-subtitle",n).addClass(this.switchClass()).addClass(s?this.switchOnClass():null).text(i).append(u().click(function(){o.hasClass(this.switchOnClass())?o.removeClass(this.switchOnClass()):o.addClass(this.switchOnClass()),e&&e.bind(this.controller(),o.hasClass(this.switchOnClass()))()}.bind(this))):o.attr("data-subtitle",n).addClass(e?this.arrowClass():null).text(i).append(u()).click(e&&e.bind(this.controller())))},this.arrowClass=function(t){return void 0===t?r:(r=t,this)},this.switchClass=function(t){return void 0===t?a:(a=t,this)},this.switchOnClass=function(t){return void 0===t?h:(h=t,this)},this.arrowClass($.extend({arrowClass:"TableViewCellArrow"},l).arrowClass),this.switchClass($.extend({switchClass:"TableViewCellSwitch"},l).switchClass),this.switchOnClass($.extend({switchOnClass:"TableViewCellSwitchOn"},l).switchOnClass),l=null,delete l}function y(i,n,e,s,t){if(!(this instanceof y))return new y(i,n,e,s,t);if(!("string"==typeof n&&0<n.length||"number"==typeof n))throw new Error("TableViewInputCell name 是必須的！");"string"!=typeof e&&"number"!=typeof e&&(e=null),"string"!=typeof s&&"number"!=typeof s&&(s=null),"string"!=typeof i&&"number"!=typeof i&&(i=null),"object"!=typeof t&&(t={}),p.call(this,$.extend({$el:c(),class:"TableViewInputCell"},t));var l=null,o=a("input"),r=$.extend({type:"text",minlength:1,maxlength:190,pattern:".{1,190}",required:!0},t.attrs);this.viewDidLoad=function(){return null!==l?l:(l=this.setUpEl()).attr("data-title",this.title()).append(o.attr(r).data("name",this.name()).val(this.value()).attr("placeholder",this.placeholder()))},this.$input=function(){return o},this.name=function(t){return null==t?n:(("string"==typeof n&&0<n.length||"number"==typeof n)&&(n=t),this)},this.value=function(t){return null==t?e:("string"!=typeof e&&"number"!=typeof e||(e=t),this)},this.placeholder=function(t){return null==t?s:("string"!=typeof s&&"number"!=typeof s||(s=t),this)},this.title=function(t){return null==t?i:("string"!=typeof i&&"number"!=typeof i||(i=t),this)},this.value(e),this.placeholder(s),this.title(i),t=null,delete t}function s(t,i,n,e){if(!(this instanceof s))return new s(t,i,n,e);"string"!=typeof t&&"number"!=typeof t&&(t=""),"function"!=typeof i&&(i=null),("string"!=typeof n||"submit"!=n&&"reset"!=n)&&(n="submit"),"object"!=typeof e&&(e={}),p.call(this,$.extend({$el:a("button"),class:"TableViewButtonCell"},e)),this.text(t).click(i).attr("type",n)}function l(t,i,n){if(!(this instanceof l))return new l(t,i,n);"string"!=typeof t&&"number"!=typeof t&&(t=null),$.isArray(i)||(i=[]),"object"!=typeof n&&(n={}),p.call(this,$.extend({class:"TableViewSection"},n)),i=i.filter(function(t){return t instanceof b||t instanceof y||t instanceof s});var e=null;this.viewDidLoad=function(){return null!==e?e:e=this.setUpEl().attr("data-title",t).append(this.rows().map(function(t){return t.controller(this.controller()).viewWillLoad().viewDidLoad()}.bind(this)))},this.rows=function(t){return null==t?i:($.isArray(t)&&(i=t),this)},this.rows(i),n=null,delete n}function o(i,t){if(!(this instanceof o))return new o(i,t);$.isArray(i)||(i=[]),"object"!=typeof t&&(t={}),f.call(this,t);var n=null,e=null;this.viewDidLoad=function(){return null!==n?n:n=this.setUpEl().append(e=this.view.controller(this).viewWillLoad().viewDidLoad().append(i.map(function(t){return t.controller(this,1).viewWillLoad().viewDidLoad()}.bind(this))))},this.sections=function(t){return void 0===t?i:(i=t.filter(function(t){return t instanceof l}),this.viewReLoad())},this.viewReLoad=function(){return null===n||(e.remove(),n=n.append(e=this.view.controller(this).viewWillLoad().viewDidLoad().append(i.map(function(t){return t.controller(this,1).viewWillLoad().viewDidLoad()}.bind(this))))),this},t&&"object"==typeof t.view&&t.view instanceof p&&(this.view=t.view),this.view.addClass("TableView"),this.sections(i),t=null,delete t}v.prototype=Object.create(p.prototype),w.prototype=Object.create(p.prototype),C.prototype=Object.create(f.prototype),b.prototype=Object.create(p.prototype),l.prototype=Object.create(p.prototype),o.prototype=Object.create(f.prototype),Object.create(f.prototype),Object.create(f.prototype),Object.create(o.prototype),Object.create(f.prototype),Object.create(f.prototype),y.prototype=Object.create(p.prototype),s.prototype=Object.create(p.prototype),Object.create(o.prototype),d.main=function(){return this._main?this._main:this._main=d({class:"Window"})},d.body=function(){return this._body?this._body:this._body=$("body")}});